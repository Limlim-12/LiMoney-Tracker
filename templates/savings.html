{% extends "base.html" %} {% block title %}Savings Vault - LiMoney{% endblock %}
{% block content %}
<div class="savings-wrapper">
  <div class="savings-header">
    <div>
      <h1><span class="header-icon">üí∞</span> Savings Vault</h1>
      <p class="section-subtitle">Track your goals and build your wealth.</p>
    </div>

    <div style="display: flex; align-items: center; gap: 1rem">
      <div class="view-controls">
        <button
          class="view-btn active"
          onclick="setView('grid')"
          id="btn-grid"
          title="Grid View"
        >
          ‚äû
        </button>
        <button
          class="view-btn"
          onclick="setView('stack')"
          id="btn-stack"
          title="Stack View"
        >
          ‚ò∞
        </button>
      </div>

      <button class="add-goal-btn" onclick="openAddSavingsModal()">
        <span>+</span> New Goal
      </button>
    </div>
  </div>

  <div class="savings-grid">
    {% if savings %} {% for goal in savings %} {% set pct = 0 %} {% if
    goal.target_amount > 0 %} {% set pct = (goal.current_balance /
    goal.target_amount) * 100 %} {% endif %}

    <div class="goal-card">
      <div class="goal-top">
        <div class="goal-icon" data-name="{{ goal.savings_name }}">üéØ</div>

        <div class="goal-menu">
          <button
            class="icon-btn success"
            title="Deposit"
            onclick="openTransactionModal('deposit', '{{ goal.id }}', '{{ goal.savings_name }}')"
          >
            ‚¨áÔ∏è
          </button>
          <button
            class="icon-btn danger"
            title="Withdraw"
            onclick="openTransactionModal('withdraw', '{{ goal.id }}', '{{ goal.savings_name }}')"
          >
            ‚¨ÜÔ∏è
          </button>

          <form
            action="{{ url_for('delete_savings', id=goal.id) }}"
            method="POST"
            onsubmit="return confirmAction(event, this, '{{ goal.savings_name }}', 'Goal')"
            style="display: inline-flex"
          >
            <button type="submit" class="icon-btn delete" title="Delete Goal">
              üóëÔ∏è
            </button>
          </form>
        </div>
      </div>

      <div class="goal-visual">
        <div
          class="progress-ring"
          style="--percent: {{ pct if pct <= 100 else 100 }};"
        >
          <svg>
            <circle cx="60" cy="60" r="52"></circle>
            <circle cx="60" cy="60" r="52" class="progress-value"></circle>
          </svg>
          <div class="ring-content">
            <span class="ring-pct">{{ "%.0f"|format(pct) }}%</span>
          </div>
        </div>
      </div>

      <div class="goal-details">
        <h3>{{ goal.savings_name }}</h3>
        <div class="money-stats">
          <span class="current-bal"
            >‚Ç±{{ "%.2f"|format(goal.current_balance) }}</span
          >
          <span class="target-bal"
            >of ‚Ç±{{ "%.2f"|format(goal.target_amount) }}</span
          >
        </div>
      </div>

      <button
        class="view-history-btn"
        onclick="toggleHistory('hist-{{ goal.id }}')"
      >
        View Transaction History ‚Üì
      </button>

      <div
        id="hist-{{ goal.id }}"
        class="history-dropdown"
        style="display: none"
      >
        {% set history = get_savings_transactions(goal.id) %} {% if history %}
        <ul class="history-list">
          {% for txn in history %}
          <li
            class="history-item {{ 'deposit' if txn.type == 'deposit' else 'withdraw' }}"
          >
            <div class="history-left">
              <span class="history-type">
                {{ '‚¨áÔ∏è Deposit' if txn.type == 'deposit' else '‚¨ÜÔ∏è Withdrawal' }}
              </span>
              <span
                class="history-date local-time"
                data-utc="{{ txn.created_at }}"
              >
                üìÖ {{ txn.created_at }}
              </span>
            </div>

            <span
              class="history-amount {{ 'text-success' if txn.type == 'deposit' else 'text-danger' }}"
            >
              {{ '+' if txn.type == 'deposit' else '-' }}‚Ç±{{
              "%.2f"|format(txn.amount) }}
            </span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div
          style="text-align: center; padding: 1rem; color: var(--text-light)"
        >
          <p style="margin: 0">No transactions yet.</p>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="empty-savings">
      <div class="empty-icon">üå±</div>
      <h3>Start Your First Savings Goal</h3>
      <p>Create a goal like "Emergency Fund" to begin.</p>
      <button class="tool-btn" onclick="openAddSavingsModal()">
        Create Goal
      </button>
    </div>
    {% endif %}
  </div>
</div>

<div id="addSavingsModal" class="modal-overlay" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üå± New Savings Goal</h3>
      <button onclick="closeModal('addSavingsModal')" class="close-modal-btn">
        √ó
      </button>
    </div>
    <form method="POST" action="{{ url_for('add_savings') }}" class="tool-form">
      <div class="form-group">
        <label>Goal Name</label>
        <input
          type="text"
          name="savings_name"
          placeholder="e.g. Dream Vacation"
          required
          class="tool-input"
        />
      </div>
      <div class="form-group">
        <label>Target Amount (‚Ç±)</label>
        <input
          type="number"
          inputmode="decimal"          
          step="0.01"
          name="target_amount"
          placeholder="10000.00"
          class="tool-input"
        />
      </div>
      <button type="submit" class="tool-btn">Create Goal</button>
    </form>
  </div>
</div>

<div id="transactionModal" class="modal-overlay" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="transTitle">Update Savings</h3>
      <button onclick="closeModal('transactionModal')" class="close-modal-btn">
        √ó
      </button>
    </div>
    <form id="transForm" method="POST" action="" class="tool-form">
      <div class="form-group">
        <label
          >Goal: <span id="transGoalName" class="highlight-text"></span
        ></label>
      </div>
      <div class="form-group">
        <label>Amount (‚Ç±)</label>
        <input
          type="number"
          inputmode="decimal"
          step="0.01"
          name=""
          id="amountInput"
          placeholder="0.00"
          required
          class="tool-input"
        />
      </div>
      <button type="submit" class="tool-btn" id="transSubmitBtn">
        Confirm
      </button>
    </form>
  </div>
</div>

<div id="confirmModal" class="modal-overlay" style="display: none">
  <div class="modal-content confirmation">
    <div class="confirm-icon-bg">‚ö†Ô∏è</div>
    <h3 class="confirm-title" id="confirmTitle">Delete Item?</h3>
    <p class="confirm-text" id="confirmText">
      Are you sure you want to remove this? This action cannot be undone.
    </p>
    <div class="confirm-actions">
      <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
      <button class="btn-confirm-delete" onclick="executeDelete()">
        Yes, Delete
      </button>
    </div>
  </div>
</div>

<script>
  // --- 1. History Toggle & Time Formatting ---
  function toggleHistory(id) {
    const el = document.getElementById(id);
    if (el.style.display === "none") {
      el.style.display = "block";
      // Update times only when opening to save performance
      updateTimes(el);
    } else {
      el.style.display = "none";
    }
  }

  function updateTimes(container) {
    const timeElements = container.querySelectorAll(".local-time");
    timeElements.forEach((el) => {
      const utcRaw = el.dataset.utc;
      if (!utcRaw) return;

      // Convert SQL UTC string (YYYY-MM-DD HH:MM:SS) to JS Date Object
      // We replace space with 'T' and add 'Z' to tell JS "This is UTC"
      const utcDate = new Date(utcRaw.replace(" ", "T") + "Z");

      // Format to local user friendly style
      // Example: "Feb 8, 2026, 1:55 PM"
      const options = {
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      };
      el.innerText = "üìÖ " + utcDate.toLocaleDateString(undefined, options);
    });
  }

  // --- 2. Confirmation Modal Logic ---
  let formToDelete = null;

  function confirmAction(event, form, name, type) {
    event.preventDefault(); // Stop default form submit
    formToDelete = form;

    // Update Modal Text
    document.getElementById("confirmTitle").innerText = `Delete ${type}?`;
    document.getElementById("confirmText").innerText =
      `Are you sure you want to delete "${name}"? This action cannot be undone.`;

    // Show Modal
    document.getElementById("confirmModal").style.display = "flex";
  }

  function executeDelete() {
    if (formToDelete) {
      formToDelete.submit(); // Actually delete
    }
  }

  function closeConfirmModal() {
    document.getElementById("confirmModal").style.display = "none";
    formToDelete = null;
  }

  // --- 3. Other Modal Logic ---
  function openAddSavingsModal() {
    document.getElementById("addSavingsModal").style.display = "flex";
  }

  function openTransactionModal(type, id, name) {
    const modal = document.getElementById("transactionModal");
    const form = document.getElementById("transForm");
    const title = document.getElementById("transTitle");
    const btn = document.getElementById("transSubmitBtn");
    const input = document.getElementById("amountInput");

    document.getElementById("transGoalName").innerText = name;
    modal.style.display = "flex";

    if (type === "deposit") {
      title.innerText = "üí∞ Add Money";
      form.action = `/deposit-savings/${id}`;
      input.name = "deposit_amount";
      btn.innerText = "Deposit Funds";
      btn.style.background = "var(--success-color)";
    } else {
      title.innerText = "üí∏ Withdraw Money";
      form.action = `/withdraw-savings/${id}`;
      input.name = "withdraw_amount";
      btn.innerText = "Withdraw Funds";
      btn.style.background = "var(--danger-color)";
    }
  }

  function closeModal(id) {
    document.getElementById(id).style.display = "none";
  }

  // Close on background click
  window.onclick = function (event) {
    if (event.target.classList.contains("modal-overlay")) {
      event.target.style.display = "none";
    }
  };

  // --- 4. Smart Icons Logic ---
  const savingsMap = {
    Emergency: "üöë",
    Rainy: "‚òî",
    Car: "üöó",
    Bike: "üèçÔ∏è",
    House: "üè†",
    Travel: "‚úàÔ∏è",
    Trip: "üó∫Ô∏è",
    Phone: "üì±",
    Computer: "üíª",
    Gift: "üéÅ",
    School: "üéì",
    Wedding: "üíç",
    Invest: "üìà",
    Bank: "üè¶",
  };

  document.querySelectorAll(".goal-icon").forEach((el) => {
    const name = el.dataset.name;
    for (const key in savingsMap) {
      if (name.includes(key) || name.includes(key.toLowerCase())) {
        el.innerText = savingsMap[key];
        break;
      }
    }
  });

  // --- View Toggle Logic ---
  // 1. Check LocalStorage on load
  document.addEventListener("DOMContentLoaded", () => {
    const savedView = localStorage.getItem("savingsView") || "grid";
    setView(savedView);
  });

  function setView(viewType) {
    const container = document.querySelector(".savings-grid");
    const btnGrid = document.getElementById("btn-grid");
    const btnStack = document.getElementById("btn-stack");

    if (viewType === "stack") {
      container.classList.add("stack-view");
      btnStack.classList.add("active");
      btnGrid.classList.remove("active");
    } else {
      container.classList.remove("stack-view");
      btnGrid.classList.add("active");
      btnStack.classList.remove("active");
    }

    // Save preference
    localStorage.setItem("savingsView", viewType);
  }
</script>
{% endblock %}
