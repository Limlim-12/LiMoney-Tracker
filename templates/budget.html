{% extends "base.html" %}
{% block title %}Smart Budget - LiMoney{% endblock %}

{% block content %}
<div class="budget-wrapper">

  <div class="budget-main">

    <div class="section-header">
      <div>
        <h1><span class="header-icon">ðŸ“Š</span> Budget Overview</h1>
        <p class="section-subtitle">Manage your spending limits and track expenses.</p>
      </div>
      <div class="total-budget-badge">
        <span class="badge-label">Total Planned</span>
        <span class="badge-amount" id="totalPlanned">â‚±0.00</span>
      </div>
    </div>

    <div class="budget-hero">
      <div class="chart-section">
        <canvas id="spendingChart"></canvas>
        <div style="position: absolute; pointer-events: none;">
          <span style="font-size: 2.5rem;">ðŸ’¸</span>
        </div>
      </div>

      <div class="legend-section">
        <h4 style="margin-bottom: 1rem; color: var(--text-secondary);">Spending Breakdown</h4>
        <div class="custom-legend">
          {% for category in categories %}
          {% set pct = 0 %}
          {% if category.planned_budget > 0 %}
          {% set pct = (category.actual_spent / category.planned_budget) * 100 %}
          {% endif %}

          {% set colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'] %}
          {% set color = colors[loop.index0 % 7] %}

          <div class="legend-item">
            <div style="display: flex; align-items: center;">
              <span class="legend-color" style="background: {{ color }}"></span>
              <span style="font-weight: 600; color: var(--text-primary);">{{ category.name }}</span>
            </div>
            <div style="text-align: right;">
              <span style="font-weight: 700; color: var(--text-primary);">â‚±{{ "%.0f"|format(category.actual_spent)
                }}</span>
              <small style="color: var(--text-light); display: block; font-size: 0.75rem;">
                of â‚±{{ "%.0f"|format(category.planned_budget) }}
              </small>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 class="subsection-title" style="margin: 0;">Detailed Usage</h3>
      <button class="tool-btn small" onclick="openAddCategoryModal()"
        style="font-size: 0.85rem; padding: 0.6rem 1.2rem;">
        + New Category
      </button>
    </div>

    <div class="category-list">
      {% for category in categories %}
      {% set pct = 0 %}
      {% if category.planned_budget > 0 %}
      {% set pct = (category.actual_spent / category.planned_budget) * 100 %}
      {% endif %}

      {% set status_class = 'status-safe' %}
      {% if pct >= 100 %}{% set status_class = 'status-danger' %}
      {% elif pct >= 80 %}{% set status_class = 'status-warning' %}{% endif %}

      <div class="modern-cat-card"
        onclick="openBudgetModal('{{ category.id }}', '{{ category.name }}', '{{ category.planned_budget }}')">

        <div class="cat-header-row">
          <span
            style="font-weight: 600; font-size: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
            <span class="cat-icon" data-name="{{ category.name }}">ðŸ“‚</span> {{ category.name }}
          </span>
          <span style="font-weight: 700; color: var(--text-primary);">
            â‚±{{ "%.2f"|format(category.actual_spent) }}
          </span>
        </div>

        <div class="progress-track">
          <div class="progress-fill {{ status_class }}" style="width: {{ [pct, 100]|min }}%"></div>
        </div>

        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-light);">
          <span style="{{ 'color: var(--danger-color); font-weight:700;' if pct >= 100 else '' }}">
            {{ "%.0f"|format(pct) }}% Used
          </span>
          <span>Target: â‚±{{ "%.0f"|format(category.planned_budget) }}</span>
        </div>

      </div>
      {% endfor %}
    </div>

  </div>
  <div class="budget-sidebar">

    <div class="tool-card">
      <h3>ðŸ’¸ Add Expense</h3>
      <form method="POST" action="{{ url_for('add_budget') }}" class="tool-form">
        <div class="form-group">
          <label>Description</label>
          <input type="text" name="expense_name" placeholder="e.g. Starbucks" required class="tool-input" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Amount</label>
            <input type="number" inputmode="decimal" step="0.01" name="expense_amount" placeholder="0.00" required class="tool-input" required />
          </div>
          <div class="form-group">
            <label>Category</label>
            <select name="category_id" required class="premium-select">
              {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <input type="hidden" name="expense_type" value="daily" />
        <input type="hidden" name="savings_id" value="" />

        <button type="submit" class="tool-btn secondary">Track Expense</button>
      </form>
    </div>

    <div class="tool-card">
      <h3>ðŸŽ¯ Set Limit</h3>
      <form method="POST" action="{{ url_for('set_planned_budget') }}" class="tool-form">
        <div class="form-group">
          <label>Category</label>
          <select name="category_id" required class="premium-select">
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Monthly Limit (â‚±)</label>
          <input type="number" inputmode="decimal" step="0.01" name="planned_budget" placeholder="5000.00" required class="tool-input" required />
        </div>
        <button type="submit" class="tool-btn secondary">Update Budget</button>
      </form>
    </div>

    <div class="tool-card history-card">
      <h3>ðŸ“œ History</h3>
      <div class="mini-history-list">
        {% if transactions %} {% for txn in transactions[:8] %}
        <div class="mini-txn-row">
          <div class="mini-txn-info">
            <span class="mini-txn-desc">{{ txn.description }}</span>
            <span class="mini-txn-cat">{{ txn.category_name }}</span>
          </div>
          <div class="mini-txn-amount">
            -â‚±{{ "%.0f"|format(txn.amount) }}
            <a href="{{ url_for('delete_budget', id=txn.id) }}" class="mini-delete" title="Delete">Ã—</a>
          </div>
        </div>
        {% endfor %} {% else %}
        <p class="empty-text">No expenses yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div id="budgetModal" class="modal-overlay" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Budget Limit</h3>
      <button onclick="closeBudgetModal()" class="close-modal-btn">Ã—</button>
    </div>
    <form method="POST" action="{{ url_for('set_planned_budget') }}" class="tool-form">
      <input type="hidden" name="category_id" id="modalCatId" />

      <div class="form-group">
        <label>Category: <span id="modalCatName" style="font-weight: bold; color: var(--primary-color)"></span></label>
      </div>

      <div class="form-group">
        <label>New Limit (â‚±)</label>
        <input type="number" inputmode="decimal" id="modalPlannedBudget" name="planned_budget" step="0.01" required class="tool-input" required
          style="border: 1px solid #ccc; background: #fff" />
      </div>

      <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 10px">
        <button type="button" onclick="closeBudgetModal()" class="tool-btn secondary"
          style="background: #e2e8f0; color: #475569">Cancel</button>
        <button type="submit" class="tool-btn">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // 1. Modal Logic
  function openBudgetModal(id, name, currentLimit) {
    document.getElementById('budgetModal').style.display = 'flex';
    document.getElementById('modalCatId').value = id;
    document.getElementById('modalCatName').innerText = name;
    document.getElementById('modalPlannedBudget').value = currentLimit;
  }

  function closeBudgetModal() {
    document.getElementById('budgetModal').style.display = 'none';
  }

  document.getElementById('budgetModal').addEventListener('click', function (e) {
    if (e.target === this) { closeBudgetModal(); }
  });

  // 2. Auto-Assign Icons
  const iconMap = {
    'Food': 'ðŸ”', 'Drink': 'ðŸ¥¤', 'Transport': 'ðŸšŒ', 'Gas': 'â›½',
    'Rent': 'ðŸ ', 'Bill': 'ðŸ’¡', 'Utility': 'âš¡', 'Grocer': 'ðŸ›’',
    'Shop': 'ðŸ›ï¸', 'Fun': 'ðŸŽ‰', 'Health': 'ðŸ’Š', 'Invest': 'ðŸ“ˆ'
  };

  document.querySelectorAll('.cat-icon').forEach(el => {
    const name = el.dataset.name;
    let icon = 'ðŸ“‚';
    for (const key in iconMap) {
      if (name.includes(key)) {
        icon = iconMap[key];
        break;
      }
    }
    el.innerText = icon;
  });

  // 3. Spending Chart (With Custom Legend Support)
  const ctx = document.getElementById('spendingChart').getContext('2d');
  const labels = [];
  const data = [];
  let totalPlanned = 0;

  {% for category in categories %}
  labels.push("{{ category.name }}");
  data.push({{ category.actual_spent }});
  totalPlanned += {{ category.planned_budget }};
  {% endfor %}

  document.getElementById('totalPlanned').innerText = "â‚±" + totalPlanned.toLocaleString(undefined, { minimumFractionDigits: 2 });

  // Matching Colors
  const chartColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'];

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: chartColors,
        borderWidth: 0,
        hoverOffset: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '75%',
      plugins: {
        legend: { display: false }, /* We use the HTML legend instead */
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(0,0,0,0.8)',
          padding: 12,
          cornerRadius: 8
        }
      },
      layout: { padding: 10 }
    }
  });
</script>
{% endblock %}